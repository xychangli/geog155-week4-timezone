<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Week 4 Time Zone Demo</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        #map {
            height: 600px;
            margin: 20px;
            border: 2px solid #ddd;
        }
        #search-container {
            text-align: center;
            margin: 20px;
        }
        #search-box {
            width: 300px;
            padding: 5px;
            font-size: 16px;
        }
        #search-button {
            padding: 6px 10px;
            font-size: 16px;
            cursor: pointer;
        }
    </style>
</head>
<body>

<!-- Show local time and UTC time -->
<div style="padding: 20px; background: #f0f0f0;">
    Local time: <span id="localTime"></span><br>
    UTC time: <span id="utcTime"></span>
</div>

<!-- Time update logic -->
<script>
    function updateTime() {
        const now = new Date();
        document.getElementById('utcTime').textContent = now.toUTCString();
        document.getElementById('localTime').textContent = now.toLocaleString();
    }
    setInterval(updateTime, 1000); // Update every 1 second
    updateTime(); // Initial display
</script>

<h2 style="text-align: center;">GEOG 155 Lab 4 Time Zone Demo</h2>
<p style="text-align: center;">Author: Chang Li</p>

<!-- Search box -->
<div id="search-container">
    <input type="text" id="search-box" placeholder="Enter a location">
    <button id="search-button">Search</button>
</div>

<!-- The map -->
<div id="map"></div>
<!-- Import Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // const initialCenter = [40.82, -96.70];  // Map center UNL City Campus
    const bounds = L.latLngBounds([-90, -180], [90, 180]);  // Restrict world, cannot drag unlimited

    const map = L.map('map', {
        worldCopyJump: false,
        maxBounds: bounds,
        maxBoundsViscosity: 0.9,
        minZoom: 2
    });

    // Load OpenStreetMap base map
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);

    let marker;

    // Load time zone geojson file
    fetch('data/timezones_wVVG8.geojson') // From: https://github.com/treyerl/timezones/tree/master
        .then(response => response.json())
        .then(data => {
            // 创建时区图层
            const timezoneLayer = L.geoJSON(data, {
                style: {
                    color: "black",      // Edge color
                    weight: 1,         // Edge width
                    fillColor: "transparent", // Fill color
                    fillOpacity: 0    // Fill opacity
                },
                onEachFeature: function(feature, layer) {
                    // Add mouse interaction
                    layer.on({
                        mouseover: function(e) { // Mouse hover turn red
                            layer.setStyle({
                                weight: 2,
                                color: "red",
                                fillColor: "red",
                                fillOpacity: 0.2
                            });
                            layer.bringToFront(); // Make current time zone on top
                        },
                        mouseout: function(e) { // Mouse leave turn black
                            layer.setStyle({
                                weight: 1,
                                color: "black",
                                fillColor: "transparent",
                                fillOpacity: 0
                            });
                        }
                    });

                    // Pop up bubble
                    if (feature.properties) {
                        const popupContent = `
                            <div class="info">
                                Time Zone: <b>UTC${feature.properties.name || 'Unknown time zone'}</b><br>
                            </div>
                        `;
                        layer.bindPopup(popupContent);
                    }
                }
            }).addTo(map);

            // Auto zoom to data boundary
            map.fitBounds(timezoneLayer.getBounds());
        })
        .catch(error => {
            console.error('Failed to load time zone data:', error);
            alert('Cannot load time zone data. Check console for errors.');
        });

    // Search for location
    document.getElementById('search-button').addEventListener('click', function() {
        const location = document.getElementById('search-box').value.trim();
        if (!location) return alert("Please enter a location.");

        // Free geocoding API?
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(location)}`, {
            headers: { 'User-Agent': 'GEOG155-TimeZone-Demo' } // Required to avoid blocking
        })
            .then(response => response.json())
            .then(data => {
                if (data.length === 0) {
                    alert("Location not found.");
                    return;
                }

                const lat = parseFloat(data[0].lat);
                const lon = parseFloat(data[0].lon);
                const displayName = data[0].display_name; // Full location name
                const latLng = [lat, lon];

                if (marker) map.removeLayer(marker);
                marker = L.marker(latLng).addTo(map);
                map.setView(latLng, 2);

                // Use Nominatim for reverse geocoding to get time zone
                fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`, {
                    headers: { 'User-Agent': 'GEOG155-TimeZone-Demo' }
                })
                    .then(response => response.json())
                    .then(reverseData => {
                        let timezone = reverseData.address.timezone || "Unknown time zone";
                        marker.bindPopup(`Location: ${displayName}<br>Time Zone: <b>${timezone}</b>`).openPopup();
                    })
                    .catch(() => {
                        marker.bindPopup(`Location: ${displayName}<br>Time Zone: <b>Unknown</b>`).openPopup();
                    });

            })
            .catch(() => alert("Error fetching location data. Try again later."));
    });

</script>

</body>
</html>